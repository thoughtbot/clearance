h1. Clearance

Rails authentication for developers who write tests.

"We have clearance, Clarence.":http://www.youtube.com/v/mNRXJEE3Nz8

h2. Integration with Suspenders

Clearance is based on the same conventions and tools as "Suspenders":http://github.com/thoughtbot/suspenders Thus if you use it, you may already have some configuration mentioned below in place.

h2. Gem installation (Rails 2.1+)

In config/environment.rb:

    config.gem 'mocha'
    config.gem 'thoughtbot-shoulda',
      :lib     => 'shoulda',
      :source  => "http://gems.github.com", 
      :version => '>= 2.0.6'
    config.gem 'thoughtbot-factory_girl',
      :lib     => 'factory_girl',
      :source  => "http://gems.github.com", 
      :version => '>= 1.1.5'
    config.gem "thoughtbot-clearance", 
      :lib     => 'clearance', 
      :source  => 'http://gems.github.com'

Then:

    rake gems:install
    rake gems:unpack

h2. The generator

In a greenfield application, make sure the development database exists and just run the generator:

    script/generate clearance

This will create:

    app/controllers/confirmations_controller.rb
    app/controllers/passwords_controller.rb
    app/controllers/sessions_controller.rb
    app/controllers/users_controller.rb
    app/models/user.rb
    app/models/user_mailer.rb
    app/views/passwords/edit.html.erb
    app/views/passwords/new.html.erb
    app/views/sessions/new.html.erb
    app/views/user_mailer/change_password.html.erb
    app/views/user_mailer/confirmation.html.erb
    app/views/users/_form.html.erb
    app/views/users/edit.html.erb
    app/views/users/new.html.erb
    test/functional/confirmations_controller_test.rb
    test/functional/passwords_controller_test.rb
    test/functional/sessions_controller_test.rb
    test/functional/users_controller_test.rb
    test/unit/clearance_mailer_test.rb
    test/unit/user_test.rb

You may already have some of these files. Don't worry. You'll be asked if you want to overwrite them.

h2. Modules

Clearance works by mixing behavior into tests, controllers, and models. For any file that you do not want to overwrite, include the corresponding Clearance module. They are namespaced exactly like the directory structure of a Rails app.

Application controller example:

    class ApplicationController < ActionController::Base
      include Clearance::App::Controllers::ApplicationController
    end

User model example:

    class User < ActiveRecord::Base
      include Clearance::App::Models::User
    end

User test example:

    class UserTest < Test::Unit::TestCase
      include Clearance::Test::Unit::UserTest
    end

h2. The migration    
    
The generator will also create a migration to add a "users" table and run it. If the table already exists in the database, the migration will just add fields and indexes that are missing and required by Clearance. If the migration fails, the generator will revert all changes back.

h2. Routes

Clearance will add these routes to your routes.rb:

    map.resources :users, :has_one => [:password, :confirmation]
    map.resource :session
    map.resources :passwords
    
Please note that Clearance depends on root_url, so please make sure that it is defined to *something* in your config/routes.rb:

    map.root :controller => 'home'
    
h2. Environments

You need to define HOST constant in your environments files. In config/environments/test.rb and config/environments/development.rb it can be:

    HOST = "localhost"

While in config/environments/production.rb it must be the actual host your application is deployed to because the constant is used by mailers to generate URLs in emails.

In config/environment.rb:

    DO_NOT_REPLY = "donotreply@example.com"

h2. Tests

The tests use "Shoulda":http://thoughtbot.com/projects/shoulda >= 2.0.4 and "Factory Girl":http://thoughtbot.com/projects/factory_girl. You need to add the Clearance module to your test/test_helper.rb:

    class Test::Unit::TestCase
      self.use_transactional_fixtures = true
      self.use_instantiated_fixtures  = false
      include Clearance::Test::TestHelper
    end

The generator will create a user factory in test/factories/clearance_user.rb unless
you have it defined somewhere else.

h2. Usage: basic workflow

Rails authentication with Clearance uses the standard approach thoughtbot and our clients have agreed upon. 

Users register (UsersController) using an email address and a password (User model). They get an email with a confirmation link (ClearanceMailer) to confirm their registration (ConfirmationController).

Registered users can sign in and out (SessionsController). If they forget their password, they request an email containing a link to change it (PasswordsController). 

h2. Usage: actions which require an authenticated user

To protect your controllers with authentication add:

    class ProtectedController < ApplicationController
      before_filter :authenticate

The filter will ensure that only authenticated users can access the controller. If someone who's not logged in tries to access a protected action: 

* the URL is stored in the session, 
* the user is redirected to log in page, and
* after successful authentication will be be redirected back to that URL.

h2. Usage: logged_in?, current_user

Clearance provides two methods that can be used in controllers, helpers, and views to check if current user is authenticated and get the actual user: 

* logged_in?
* current_user

This may be familiar to you if you've used "restful_authentication":http://github.com/technoweenie/restful-authentication.
    
    <% if logged_in? -%>
      Hello, <%= current_user.name %>!
    <% else -%>
      Please <%= link_to 'Log in', new_session_path %>
    <% end -%>
    
h2. Usage: mass assignment

Please note that all User attributes except email, password and password_confirmation are protected from mass assignment by default. Use attr_accessible to enable it for your custom attributes.
    
    class User < ActiveRecord::Base
      include Clearance::App::Models::User
      attr_accessible :first_name, :last_name
    ...

h2. Hooks and overwritables: return_to parameter

If you want to specify where to redirect a user (say you want to have a login box on every page and redirect the user to the same page) after he/she signs in, you can add a "return_to" parameter to the request (thanks to "Phillippe":http://www.sivarg.com/2009/01/clearance-coming-from-where-your-were.html for the tip):

    <% form_for :session, :url => session_path(:return_to => request.request_uri) do |form| %> 
    ...

h2. Hooks and overwritables: url_after_create, url_after_destroy
    
Actions that redirect (create and destroy) in Clearance controllers are customizable. If you want to redirect a user to a specific route after signing in, overwrite the "url_after_create" method in the SessionsController:

    class SessionsController < ApplicationController
      include Clearance::App::Controllers::SessionsController
      
      private
      
        def url_after_create
          new_blog_post_path
        end
    end

There are similar methods in other controllers as well:

    UsersController#url_after_create (sign up)
    SessionsController#url_after_create (sign in)
    SessionsController#url_after_destroy (sign out)
    PasswordsController#url_after_create (password reset request)
    ConfirmationsController#url_after_create (confirmation)

h2. Hooks and overrides: log_user_in

Say you want to add a last_logged_in_at attribute to your User model. You would want to update it when the User logs in.

Clearance has a method named log_user_in that you can override with that logic. Be sure to call login(user) at the end (and write tests!).

    class ApplicationController < ActionController::Base
      include Clearance::App::Controllers::ApplicationController
      
      private
        
        def log_user_in(user)
          # store current time to display "last logged in at" message
          user.update_attribute(:last_logged_in_at, Time.now)
          login(user)
        end
    end 

h2. Authors

* thoughtbot, inc.
* Dan Croak
* Jason Morrison
* Mike Burns
* Josh Nichols
* Mike Breen
* Eugene Bolshakov
